var DEFAULT_OUTPUT_EXT,MODE,SLEET_FILE,VERSION,checkExists,checkWatchedFile,compile,compileDir,compileFile,compileIt,dirfiles,fs,getDirctoryFiles,getOutputFile,isFileInWatchedDir,isSleetFile,mkdirp,mtime,path,watchDir,watchFile,watchr,yargs;fs=require("fs"),path=require("path"),watchr=require("watchr"),compile=require("./sleet").compile,SLEET_FILE=".sleet",DEFAULT_OUTPUT_EXT="html",MODE=511&~process.umask(),VERSION="Sleet version 0.0.0",yargs=require("yargs").usage("$0 [options] input.st [input2.st...]").describe("o","The output diretory").describe("e","The file extension of output file").describe("w","Watch file changes").describe("v","Show the version number").describe("h","Show this message").alias("o","output").alias("e","extension").alias("w","watch").alias("v","version").alias("h","help")["boolean"]("v")["boolean"]("h")["boolean"]("w").string("e").string("o"),exports.run=function(){var e,i,t,r,n,s,o,c,l,a,h;if(e=yargs.argv,t=e._.slice(),e.h)return yargs.showHelp();if(e.v)return console.log(VERSION);if(t=checkExists(t),t.length>0){for(s={files:{},dirs:{}},o=0,c=t.length;c>o;o++)i=t[o],fs.statSync(i).isDirectory()?(compileDir(i,e),s.dirs[i]=!0):(compileFile(i,e),s.files[i]=!0);if(e.w){l=s.dirs;for(r in l)n=l[r],watchDir(r,e,s.dirs);a=s.files,h=[];for(r in a)n=a[r],isFileInWatchedDir(r,s.dirs)||h.push(watchFile(r,e,s.files));return h}}},checkExists=function(e){var i,t,r,n;for(t=[],r=0,n=e.length;n>r;r++)i=e[r],fs.existsSync(i)?t.push(path.resolve(i)):console.error("The specified file '"+i+"' is not exists");return t},compileFile=function(e,i){return compileIt(e,getOutputFile(e,i))},compileDir=function(e,i){var t,r,n,s,o;for(s=getDirctoryFiles(path.resolve(e)),o=[],r=0,n=s.length;n>r;r++)t=s[r],o.push(compileIt(t,getOutputFile(t,i,e)));return o},watchDir=function(e,i,t,r){var n,s,o,c,l,a,h,u,f,p,m;for(console.log("watching directory "+e),r||(r=e),c=t[e]={files:{}},p=getDirctoryFiles(e,!0),a=0,u=p.length;u>a;a++)s=p[a],c.files[s]={compiling:!1,last:mtime(s)};for(m=fs.readdirSync(e),h=0,f=m.length;f>h;h++)s=m[h],n=path.join(e,s),fs.statSync(n).isDirectory()&&(o=(l=c.files)[n]||(l[n]={}),watchDir(n,i,o,e));return c.watcher=fs.watch(e).on("change",function(){var t,n,l,a,h;for(a=getDirctoryFiles(e,!0),h=[],n=0,l=a.length;l>n;n++)s=a[n],o=(t=c.files)[s]||(t[s]={compiling:!1,last:mtime(s)}),h.push(checkWatchedFile(s,o,i,r));return h})},watchFile=function(e,i,t){var r;return console.log("watching file "+e),r=t[e]={compiling:!1,last:mtime(e)},r.watcher=fs.watch(e).on("change",function(){return checkWatchedFile(e,r,i)})},isSleetFile=function(e){return path.extname(e)===SLEET_FILE},mkdirp=function(e){return fs.existsSync(e)?void 0:(mkdirp(path.dirname(e)),fs.mkdir(e,MODE))},mtime=function(e){return fs.statSync(e).mtime.getTime()},dirfiles=function(e,i,t){var r,n,s,o,c,l;for(c=fs.readdirSync(e),l=[],s=0,o=c.length;o>s;s++)r=c[s],n=path.join(e,r),l.push(fs.statSync(n).isDirectory()?t?void 0:dirfiles(n,i):isSleetFile(n)?i.push(n):void 0);return l},checkWatchedFile=function(e,i,t,r){var n;return n=mtime(e),n-i.last>0&&!i.compiling?(i.last=n,i.compiling=!0,compileIt(e,getOutputFile(e,t,r)),i.compiling=!1):void 0},getOutputFile=function(e,i,t){var r,n,s;return n=i.e||DEFAULT_OUTPUT_EXT,s=path.basename(e,path.extname(e))+"."+n,r=path.dirname(e),t||(t=r),i.o?(r=path.join(path.resolve("."),i.o,path.relative(t,r)),mkdirp(r),path.join(r,s)):path.join(r,s)},getDirctoryFiles=function(e,i){var t;return t=[],dirfiles(e,t,i),t},compileIt=function(e,i){var t,r,n;t=fs.readFileSync(e,"utf8");try{n=compile(t)}catch(s){return r=s,console.error(r)}return fs.writeFileSync(i,n,"utf8"),console.log((new Date).toLocaleTimeString()+" - Compiled '"+e+"' to '"+i+"'")},isFileInWatchedDir=function(e,i){var t,r;for(t in i)if(r=i[t],0===e.indexOf(t))return!0;return!1};