var MODE,SLEET_FILE,VERSION,checkExists,checkWatchedFile,compile,compileDir,compileFile,compileIt,dirfiles,findOptionsInPackage,fs,getDirctoryFiles,getOutputFile,isFileInWatchedDir,isSleetFile,mkdirp,mtime,path,runIt,watchDir,watchFile,yargs;fs=require("fs"),path=require("path"),compile=require("./sleet").compile,SLEET_FILE=".sleet",MODE=511&~process.umask(),VERSION="Sleet version 0.0.11",yargs=require("yargs").usage("$0 [options] input.st [input2.st...]").describe("o","The output directory").describe("w","Watch file changes").describe("v","Show the version number").describe("h","Show this message").alias("o","output").alias("w","watch").alias("v","version").alias("h","help")["boolean"]("v")["boolean"]("h")["boolean"]("w").string("o"),exports.run=function(){var e;return e=yargs.argv,e.files=e._.slice(),e.h?yargs.showHelp():e.v?console.log(VERSION):runIt(e)},runIt=exports.runIt=function(e){var i,t,r,n,o,s,c,a,l,h,u;if(null==e&&(e={}),t=checkExists(e.files||[]),t.length>0){for(u={files:{},dirs:{}},r=0,o=t.length;o>r;r++)i=t[r],fs.statSync(i).isDirectory()?(s=findOptionsInPackage(i,!1),compileDir(i,e,s),u.dirs[i]=s):(s=findOptionsInPackage(i,!0),compileFile(i,e,s),u.files[i]=s);if(e.watch){c=u.dirs;for(n in c)h=c[n],watchDir(n,e,u.dirs,h);a=u.files,l=[];for(n in a)h=a[n],isFileInWatchedDir(n,u.dirs)||l.push(watchFile(n,e,u.files,h));return l}}},findOptionsInPackage=function(e,i){var t,r,n;for(n=i?path.dirname(e):e,n=path.resolve(n);path.dirname(n)!==n;){if(t=path.join(n,"package.json"),fs.existsSync(t))return null!=(r=require(t))?r.sleet:void 0;n=path.dirname(n)}return null},checkExists=function(e){var i,t,r,n;for(n=[],t=0,r=e.length;r>t;t++)i=e[t],fs.existsSync(i)?n.push(path.resolve(i)):console.error("The specified file '"+i+"' is not exists");return n},compileFile=function(e,i,t){return compileIt(e,getOutputFile(e,i),i,t)},compileDir=function(e,i,t){var r,n,o,s,c;for(s=getDirctoryFiles(path.resolve(e)),c=[],n=0,o=s.length;o>n;n++)r=s[n],c.push(compileIt(r,getOutputFile(r,i,e),i,t));return c},watchDir=function(e,i,t,r,n){var o,s,c,a,l,h,u,f,p,m,d;for(console.log("watching directory "+e),r||(r=e),p=t[e]={files:{}},m=getDirctoryFiles(e,!0),a=0,h=m.length;h>a;a++)c=m[a],p.files[c]={compiling:!1,last:mtime(c)};for(d=fs.readdirSync(e),l=0,u=d.length;u>l;l++)c=d[l],s=path.join(e,c),fs.statSync(s).isDirectory()&&(f=(o=p.files)[s]||(o[s]={}),watchDir(s,i,f,e));return p.watcher=fs.watch(e).on("change",function(){var t,o,s,a,l;for(a=getDirctoryFiles(e,!0),l=[],o=0,s=a.length;s>o;o++)c=a[o],f=(t=p.files)[c]||(t[c]={compiling:!1,last:mtime(c)}),l.push(checkWatchedFile(c,f,i,r,n));return l})},watchFile=function(e,i,t,r){var n;return console.log("watching file "+e),n=t[e]={compiling:!1,last:mtime(e)},n.watcher=fs.watch(e).on("change",function(){return checkWatchedFile(e,n,i,r)})},isSleetFile=function(e){return path.extname(e)===SLEET_FILE},mkdirp=function(e){return fs.existsSync(e)?void 0:(mkdirp(path.dirname(e)),fs.mkdir(e,MODE))},mtime=function(e){return fs.statSync(e).mtime.getTime()},dirfiles=function(e,i,t){var r,n,o,s,c,a;for(c=fs.readdirSync(e),a=[],n=0,o=c.length;o>n;n++)r=c[n],s=path.join(e,r),a.push(fs.statSync(s).isDirectory()?t?void 0:dirfiles(s,i):isSleetFile(s)?i.push(s):void 0);return a},checkWatchedFile=function(e,i,t,r,n){var o;return o=mtime(e),o-i.last>0&&!i.compiling?(i.last=o,i.compiling=!0,compileIt(e,getOutputFile(e,t,r),t,n),i.compiling=!1):void 0},getOutputFile=function(e,i,t){var r,n;return n=path.basename(e,path.extname(e)),r=path.dirname(e),t||(t=r),i.o?(r=path.join(path.resolve("."),i.o,path.relative(t,r)),mkdirp(r),path.join(r,n)):path.join(r,n)},getDirctoryFiles=function(e,i){var t;return t=[],dirfiles(e,t,i),t},compileIt=function(e,i,t,r){var n,o,s,c,a;n=fs.readFileSync(e,"utf8"),c=r||{},c.filename=e;try{a=compile(n,c)}catch(l){return o=l,console.log(o.stack)}return i+="."+a.extension,s="function"==typeof c.transform?c.transform(a.content,e,i):void 0,s||(s=a.content),fs.writeFileSync(i,s,"utf8"),console.log((new Date).toLocaleTimeString()+" - Compiled '"+e+"' to '"+i+"'")},isFileInWatchedDir=function(e,i){var t,r;for(t in i)if(r=i[t],0===e.indexOf(t))return!0;return!1};