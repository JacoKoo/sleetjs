var DEFAULT_OUTPUT_EXT,MODE,SLEET_FILE,VERSION,checkExists,checkWatchedFile,compile,compileDir,compileFile,compileIt,dirfiles,fs,getDirctoryFiles,getOutputFile,isFileInWatchedDir,isSleetFile,mkdirp,mtime,path,watchDir,watchFile,yargs;fs=require("fs"),path=require("path"),compile=require("./sleet").compile,SLEET_FILE=".sleet",DEFAULT_OUTPUT_EXT="html",MODE=511&~process.umask(),VERSION="Sleet version 0.0.2",yargs=require("yargs").usage("$0 [options] input.st [input2.st...]").describe("o","The output directory").describe("e","The file extension of output file").describe("w","Watch file changes").describe("v","Show the version number").describe("h","Show this message").alias("o","output").alias("e","extension").alias("w","watch").alias("v","version").alias("h","help")["boolean"]("v")["boolean"]("h")["boolean"]("w").string("e").string("o"),exports.run=function(e){var i,t,r,n,o,s,l,c,a,h,u;if(null==e&&(e={}),i=yargs.argv,i.compileOptions=e,r=i._.slice(),i.h)return yargs.showHelp();if(i.v)return console.log(VERSION);if(r=checkExists(r),r.length>0){for(s={files:{},dirs:{}},l=0,c=r.length;c>l;l++)t=r[l],fs.statSync(t).isDirectory()?(compileDir(t,i),s.dirs[t]=!0):(compileFile(t,i),s.files[t]=!0);if(i.w){a=s.dirs;for(n in a)o=a[n],watchDir(n,i,s.dirs);h=s.files,u=[];for(n in h)o=h[n],isFileInWatchedDir(n,s.dirs)||u.push(watchFile(n,i,s.files));return u}}},checkExists=function(e){var i,t,r,n;for(t=[],r=0,n=e.length;n>r;r++)i=e[r],fs.existsSync(i)?t.push(path.resolve(i)):console.error("The specified file '"+i+"' is not exists");return t},compileFile=function(e,i){return compileIt(e,getOutputFile(e,i),i)},compileDir=function(e,i){var t,r,n,o,s;for(o=getDirctoryFiles(path.resolve(e)),s=[],r=0,n=o.length;n>r;r++)t=o[r],s.push(compileIt(t,getOutputFile(t,i,e),i));return s},watchDir=function(e,i,t,r){var n,o,s,l,c,a,h,u,f,p,m;for(console.log("watching directory "+e),r||(r=e),l=t[e]={files:{}},p=getDirctoryFiles(e,!0),a=0,u=p.length;u>a;a++)o=p[a],l.files[o]={compiling:!1,last:mtime(o)};for(m=fs.readdirSync(e),h=0,f=m.length;f>h;h++)o=m[h],n=path.join(e,o),fs.statSync(n).isDirectory()&&(s=(c=l.files)[n]||(c[n]={}),watchDir(n,i,s,e));return l.watcher=fs.watch(e).on("change",function(){var t,n,c,a,h;for(a=getDirctoryFiles(e,!0),h=[],n=0,c=a.length;c>n;n++)o=a[n],s=(t=l.files)[o]||(t[o]={compiling:!1,last:mtime(o)}),h.push(checkWatchedFile(o,s,i,r));return h})},watchFile=function(e,i,t){var r;return console.log("watching file "+e),r=t[e]={compiling:!1,last:mtime(e)},r.watcher=fs.watch(e).on("change",function(){return checkWatchedFile(e,r,i)})},isSleetFile=function(e){return path.extname(e)===SLEET_FILE},mkdirp=function(e){return fs.existsSync(e)?void 0:(mkdirp(path.dirname(e)),fs.mkdir(e,MODE))},mtime=function(e){return fs.statSync(e).mtime.getTime()},dirfiles=function(e,i,t){var r,n,o,s,l,c;for(l=fs.readdirSync(e),c=[],o=0,s=l.length;s>o;o++)r=l[o],n=path.join(e,r),c.push(fs.statSync(n).isDirectory()?t?void 0:dirfiles(n,i):isSleetFile(n)?i.push(n):void 0);return c},checkWatchedFile=function(e,i,t,r){var n;return n=mtime(e),n-i.last>0&&!i.compiling?(i.last=n,i.compiling=!0,compileIt(e,getOutputFile(e,t,r),t),i.compiling=!1):void 0},getOutputFile=function(e,i,t){var r,n,o;return n=i.e||DEFAULT_OUTPUT_EXT,o=path.basename(e,path.extname(e))+"."+n,r=path.dirname(e),t||(t=r),i.o?(r=path.join(path.resolve("."),i.o,path.relative(t,r)),mkdirp(r),path.join(r,o)):path.join(r,o)},getDirctoryFiles=function(e,i){var t;return t=[],dirfiles(e,t,i),t},compileIt=function(e,i,t){var r,n,o,s;r=fs.readFileSync(e,"utf8"),o=t.compileOptions||{},o.filename=e;try{s=compile(r,o)}catch(l){return n=l,console.error(n)}return fs.writeFileSync(i,s,"utf8"),console.log((new Date).toLocaleTimeString()+" - Compiled '"+e+"' to '"+i+"'")},isFileInWatchedDir=function(e,i){var t,r;for(t in i)if(r=i[t],0===e.indexOf(t))return!0;return!1};