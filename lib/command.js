var DEFAULT_OUTPUT_EXT,MODE,SLEET_FILE,VERSION,checkExists,checkWatchedFile,compile,compileDir,compileFile,compileIt,dirfiles,fs,getDirctoryFiles,getOutputFile,isFileInWatchedDir,isSleetFile,mkdirp,mtime,path,runIt,watchDir,watchFile,yargs;fs=require("fs"),path=require("path"),compile=require("./sleet").compile,SLEET_FILE=".sleet",DEFAULT_OUTPUT_EXT="html",MODE=511&~process.umask(),VERSION="Sleet version 0.0.5",yargs=require("yargs").usage("$0 [options] input.st [input2.st...]").describe("o","The output directory").describe("e","The file extension of output file").describe("w","Watch file changes").describe("v","Show the version number").describe("h","Show this message").alias("o","output").alias("e","extension").alias("w","watch").alias("v","version").alias("h","help")["boolean"]("v")["boolean"]("h")["boolean"]("w").string("e").string("o"),exports.run=function(e){var i;return null==e&&(e={}),i=yargs.argv,i.compileOptions=e,i.files=i._.slice(),i.h?yargs.showHelp():i.v?console.log(VERSION):runIt(i)},runIt=exports.runIt=function(e){var i,t,r,n,o,s,l,c,a,h;if(null==e&&(e={}),t=checkExists(e.files||[]),t.length>0){for(o={files:{},dirs:{}},s=0,l=t.length;l>s;s++)i=t[s],fs.statSync(i).isDirectory()?(compileDir(i,e),o.dirs[i]=!0):(compileFile(i,e),o.files[i]=!0);if(e.watch){c=o.dirs;for(r in c)n=c[r],watchDir(r,e,o.dirs);a=o.files,h=[];for(r in a)n=a[r],isFileInWatchedDir(r,o.dirs)||h.push(watchFile(r,e,o.files));return h}}},checkExists=function(e){var i,t,r,n;for(t=[],r=0,n=e.length;n>r;r++)i=e[r],fs.existsSync(i)?t.push(path.resolve(i)):console.error("The specified file '"+i+"' is not exists");return t},compileFile=function(e,i){return compileIt(e,getOutputFile(e,i),i)},compileDir=function(e,i){var t,r,n,o,s;for(o=getDirctoryFiles(path.resolve(e)),s=[],r=0,n=o.length;n>r;r++)t=o[r],s.push(compileIt(t,getOutputFile(t,i,e),i));return s},watchDir=function(e,i,t,r){var n,o,s,l,c,a,h,u,f,p,m;for(console.log("watching directory "+e),r||(r=e),l=t[e]={files:{}},p=getDirctoryFiles(e,!0),a=0,u=p.length;u>a;a++)o=p[a],l.files[o]={compiling:!1,last:mtime(o)};for(m=fs.readdirSync(e),h=0,f=m.length;f>h;h++)o=m[h],n=path.join(e,o),fs.statSync(n).isDirectory()&&(s=(c=l.files)[n]||(c[n]={}),watchDir(n,i,s,e));return l.watcher=fs.watch(e).on("change",function(){var t,n,c,a,h;for(a=getDirctoryFiles(e,!0),h=[],n=0,c=a.length;c>n;n++)o=a[n],s=(t=l.files)[o]||(t[o]={compiling:!1,last:mtime(o)}),h.push(checkWatchedFile(o,s,i,r));return h})},watchFile=function(e,i,t){var r;return console.log("watching file "+e),r=t[e]={compiling:!1,last:mtime(e)},r.watcher=fs.watch(e).on("change",function(){return checkWatchedFile(e,r,i)})},isSleetFile=function(e){return path.extname(e)===SLEET_FILE},mkdirp=function(e){return fs.existsSync(e)?void 0:(mkdirp(path.dirname(e)),fs.mkdir(e,MODE))},mtime=function(e){return fs.statSync(e).mtime.getTime()},dirfiles=function(e,i,t){var r,n,o,s,l,c;for(l=fs.readdirSync(e),c=[],o=0,s=l.length;s>o;o++)r=l[o],n=path.join(e,r),c.push(fs.statSync(n).isDirectory()?t?void 0:dirfiles(n,i):isSleetFile(n)?i.push(n):void 0);return c},checkWatchedFile=function(e,i,t,r){var n;return n=mtime(e),n-i.last>0&&!i.compiling?(i.last=n,i.compiling=!0,compileIt(e,getOutputFile(e,t,r),t),i.compiling=!1):void 0},getOutputFile=function(e,i,t){var r,n,o;return n=i.e||DEFAULT_OUTPUT_EXT,o=path.basename(e,path.extname(e))+"."+n,r=path.dirname(e),t||(t=r),i.o?(r=path.join(path.resolve("."),i.o,path.relative(t,r)),mkdirp(r),path.join(r,o)):path.join(r,o)},getDirctoryFiles=function(e,i){var t;return t=[],dirfiles(e,t,i),t},compileIt=function(e,i,t){var r,n,o,s,l;r=fs.readFileSync(e,"utf8"),s=t.compileOptions||{},s.filename=e;try{l=compile(r,s)}catch(c){return n=c,console.error(n)}return o="function"==typeof s.transform?s.transform(l,e,i):void 0,o||(o=l),fs.writeFileSync(i,o,"utf8"),console.log((new Date).toLocaleTimeString()+" - Compiled '"+e+"' to '"+i+"'")},isFileInWatchedDir=function(e,i){var t,r;for(t in i)if(r=i[t],0===e.indexOf(t))return!0;return!1};